#*****************************************************************
# File:   Makefile
# Author: Práctica 5 PSCD
# Date:   diciembre 2025
# Coms:   Makefile para la práctica 5 distribuida
#         "make" construye todos los ejecutables
#         "make ejercicios" construye los ejercicios previos
#         "make clean" limpia todos los archivos objeto y ejecutables
#*****************************************************************

CC=g++

# Práctica 5 - Sistema distribuido
SERVIDOR_TAREAS=ServidorTareas
SERVIDOR_MATRIZ=ServidorMatriz
CONTROLADOR=Controlador

# Ejercicios previos
CLIENTE=Cliente
SERVIDOR=Servidor
MULTI_SERVIDOR=ServidorMulticliente

SOCKET_DIR=Socket
SOCKET=${SOCKET_DIR}/Socket
MONITORES_DIR=librerias/Monitores
MULTIBUFFER_DIR=librerias/MultiBuffer

CPPFLAGS=-I. -I${SOCKET_DIR} -I${MONITORES_DIR} -I${MULTIBUFFER_DIR} -std=c++11
LDFLAGS=-pthread

# Descomentar la siguiente línea para compilar en hendrix
#SOCKETSFLAGS=-lsocket -lnsl

# Por defecto, compila la práctica 5
all: ${SERVIDOR_TAREAS} ${SERVIDOR_MATRIZ} ${CONTROLADOR}

# Para compilar los ejercicios previos
ejercicios: ${CLIENTE} ${SERVIDOR} ${MULTI_SERVIDOR}

#-----------------------------------------------------------
# SERVIDOR DE TAREAS

# Monitores necesarios
${MONITORES_DIR}/BufferTareas.o: ${MONITORES_DIR}/BufferTareas.cpp ${MONITORES_DIR}/BufferTareas.hpp
	${CC} -c ${CPPFLAGS} ${MONITORES_DIR}/BufferTareas.cpp -o ${MONITORES_DIR}/BufferTareas.o

# Compilación
${SERVIDOR_TAREAS}.o: ${SERVIDOR_TAREAS}.cpp tarea.hpp
	${CC} -c ${CPPFLAGS} ${SERVIDOR_TAREAS}.cpp

# Linkado
${SERVIDOR_TAREAS}: ${SOCKET}.o ${SERVIDOR_TAREAS}.o ${MONITORES_DIR}/BufferTareas.o
	${CC} ${LDFLAGS} ${SOCKET}.o ${SERVIDOR_TAREAS}.o ${MONITORES_DIR}/BufferTareas.o -o ${SERVIDOR_TAREAS} ${SOCKETSFLAGS}

#-----------------------------------------------------------
# SERVIDOR DE MATRIZ

# Monitores necesarios
${MONITORES_DIR}/GestionResultados.o: ${MONITORES_DIR}/GestionResultados.cpp ${MONITORES_DIR}/GestionResultados.hpp
	${CC} -c ${CPPFLAGS} ${MONITORES_DIR}/GestionResultados.cpp -o ${MONITORES_DIR}/GestionResultados.o

# Compilación
${SERVIDOR_MATRIZ}.o: ${SERVIDOR_MATRIZ}.cpp
	${CC} -c ${CPPFLAGS} ${SERVIDOR_MATRIZ}.cpp

# Linkado
${SERVIDOR_MATRIZ}: ${SOCKET}.o ${SERVIDOR_MATRIZ}.o ${MONITORES_DIR}/GestionResultados.o
	${CC} ${LDFLAGS} ${SOCKET}.o ${SERVIDOR_MATRIZ}.o ${MONITORES_DIR}/GestionResultados.o -o ${SERVIDOR_MATRIZ} ${SOCKETSFLAGS}

#-----------------------------------------------------------
# CONTROLADOR

# Compilación
${CONTROLADOR}.o: ${CONTROLADOR}.cpp tarea.hpp
	${CC} -c ${CPPFLAGS} ${CONTROLADOR}.cpp

# Linkado
${CONTROLADOR}: ${SOCKET}.o ${CONTROLADOR}.o
	${CC} ${LDFLAGS} ${SOCKET}.o ${CONTROLADOR}.o -o ${CONTROLADOR} ${SOCKETSFLAGS}

#-----------------------------------------------------------
# SOCKETS

${SOCKET}.o: ${SOCKET}.hpp ${SOCKET}.cpp
	${CC} -c ${CPPFLAGS} ${SOCKET}.cpp -o ${SOCKET}.o

#-----------------------------------------------------------
# EJERCICIOS PREVIOS

# CLIENTE (Ejercicio 1)
${CLIENTE}.o: ${CLIENTE}.cpp
	${CC} -c ${CPPFLAGS} ${CLIENTE}.cpp

${CLIENTE}: ${SOCKET}.o ${CLIENTE}.o  
	${CC} ${LDFLAGS} ${SOCKET}.o ${CLIENTE}.o -o ${CLIENTE} ${SOCKETSFLAGS}

# SERVIDOR (Ejercicio 1)
${SERVIDOR}.o: ${SERVIDOR}.cpp 
	${CC} -c ${CPPFLAGS} ${SERVIDOR}.cpp

${SERVIDOR}: ${SOCKET}.o ${SERVIDOR}.o
	${CC} ${LDFLAGS} ${SOCKET}.o ${SERVIDOR}.o -o ${SERVIDOR} ${SOCKETSFLAGS}

# SERVIDOR MULTICLIENTE (Ejercicio 2)
${MULTI_SERVIDOR}.o: ${MULTI_SERVIDOR}.cpp 
	${CC} -c ${CPPFLAGS} ${MULTI_SERVIDOR}.cpp

${MULTI_SERVIDOR}: ${SOCKET}.o ${MULTI_SERVIDOR}.o
	${CC} ${LDFLAGS} ${SOCKET}.o ${MULTI_SERVIDOR}.o -o ${MULTI_SERVIDOR} ${SOCKETSFLAGS}

#-----------------------------------------------------------
# LIMPIEZA

clean:
	$(RM) ${SOCKET}.o
	$(RM) ${SERVIDOR_TAREAS} ${SERVIDOR_TAREAS}.o
	$(RM) ${SERVIDOR_MATRIZ} ${SERVIDOR_MATRIZ}.o
	$(RM) ${CONTROLADOR} ${CONTROLADOR}.o
	$(RM) ${CLIENTE} ${CLIENTE}.o
	$(RM) ${SERVIDOR} ${SERVIDOR}.o
	$(RM) ${MULTI_SERVIDOR} ${MULTI_SERVIDOR}.o
	$(RM) ${MONITORES_DIR}/BufferTareas.o
	$(RM) ${MONITORES_DIR}/GestionResultados.o
	$(RM) *.log